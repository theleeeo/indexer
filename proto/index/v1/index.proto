syntax = "proto3";

package index.v1;

import "google/protobuf/struct.proto";

option go_package = "indexer/gen/index/v1;index";

service IndexService {
  rpc Publish(PublishRequest) returns (PublishResponse);
  rpc PublishBatch(PublishBatchRequest) returns (PublishBatchResponse);
}

message PublishRequest {
  ChangeEvent event = 1;
}


message PublishResponse {}

message PublishBatchRequest {
  repeated ChangeEvent events = 1;
}

message PublishBatchResponse {}

message ChangeEvent {
  oneof payload {
    CreatePayload create_payload = 1;
    UpdatePayload update_payload = 2;
    DeletePayload delete_payload = 3;
  }
}

message CreatePayload {
  string                 resource    = 1;
  string                 resource_id = 2;
  google.protobuf.Struct data        = 3;
  repeated Relation      relations   = 4;
}

message UpdatePayload {
  string                  resource         = 1;
  string                  resource_id      = 2;
  google.protobuf.Struct  data             = 3;
  repeated RelationChange relation_changes = 4;
}

message DeletePayload {
  string resource    = 1;
  string resource_id = 2;
}

message RelationChange {
  Relation relation = 1;

  enum ChangeType {
    CHANGE_TYPE_UNSPECIFIED = 0;
    CHANGE_TYPE_ADDED       = 1;
    CHANGE_TYPE_REMOVED     = 2;
    CHANGE_TYPE_SET         = 3;
  }
  ChangeType change_type             = 2;
}

message Relation {
  string resource    = 1;
  string resource_id = 2;
}
