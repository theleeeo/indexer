syntax = "proto3";

package index.v1;

import "google/protobuf/struct.proto";

option go_package = "indexer/gen/index/v1;index";

service IndexService {
  rpc Publish(PublishRequest) returns (PublishResponse);
  rpc PublishBatch(PublishBatchRequest) returns (PublishBatchResponse);
}

message PublishRequest {
  ChangeEvent event = 1;
}


message PublishResponse {}

message PublishBatchRequest {
  repeated ChangeEvent events = 1;
}

message PublishBatchResponse {}

message ChangeEvent {
  oneof payload {
    CreatePayload         create_payload          = 1;
    UpdatePayload         update_payload          = 2;
    DeletePayload         delete_payload          = 3;
    AddRelationPayload    add_relation_payload    = 4;
    RemoveRelationPayload remove_relation_payload = 5;
    SetRelationPayload    set_relation_payload    = 6;
  }
}

message CreatePayload {
  string                 resource    = 1;
  string                 resource_id = 2;
  google.protobuf.Struct data        = 3;
  repeated Relation      relations   = 4;
}

message UpdatePayload {
  string                 resource    = 1;
  string                 resource_id = 2;
  google.protobuf.Struct data        = 3;
}

message DeletePayload {
  string resource    = 1;
  string resource_id = 2;
}

message AddRelationPayload {
  string   resource        = 1;
  string   resource_id     = 2;
  Relation relation_to_add = 3;
}

message RemoveRelationPayload {
  string   resource           = 1;
  string   resource_id        = 2;
  Relation relation_to_remove = 3;
}

message SetRelationPayload {
  string   resource        = 1;
  string   resource_id     = 2;
  Relation relation_to_set = 3;
}

message Relation {
  string resource    = 1;
  string resource_id = 2;
}
