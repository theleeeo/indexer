syntax = "proto3";

package indexer.v1;

import "google/protobuf/struct.proto";

option go_package = "indexer/gen/indexer/v1;indexer";

service Indexer {
  rpc Publish(ChangeEvent) returns (PublishResponse);
  rpc PublishBatch(ChangeBatch) returns (PublishResponse);

  rpc SearchA(SearchRequest) returns (SearchResponse);
  rpc SearchB(SearchRequest) returns (SearchResponse);
  rpc SearchC(SearchRequest) returns (SearchResponse);
}

message PublishResponse {
  int64 accepted = 1;
}

message ChangeBatch {
  repeated ChangeEvent events = 1;
}

message ChangeEvent {
  // Used for idempotency / de-dup on the indexer side.
  string  event_id            = 1;

  // For debugging/ordering only (donâ€™t rely on strict ordering).
  int64   occurred_at_unix_ms = 2;

  string  tenant_id           = 3;

  oneof payload {
    AUpsert a_upsert            = 10;
    ADelete a_delete            = 11;

    BUpsert b_upsert            = 20;
    BDelete b_delete            = 21;

    CUpsert c_upsert            = 30;
    CDelete c_delete            = 31;
  }
}

message AUpsert {
  string          a_id   = 1;

  // Example A fields you might filter/sort on:
  string          status = 2;

  // Relationships:
  string          b_id   = 10;
  repeated string c_ids  = 11;
}

message ADelete {
  string a_id = 1;
}

message BUpsert {
  string b_id = 1;
  string name = 2;
}

message BDelete {
  string b_id = 1;
}

message CUpsert {
  string c_id  = 1;
  string type  = 2;
  string state = 3;
}

message CDelete {
  string c_id = 1;
}

enum FilterOp {
  FILTER_OP_UNSPECIFIED = 0;
  FILTER_OP_EQ          = 1; // term query
  FILTER_OP_IN          = 2; // terms query
}

message Filter {
  // Example: "b.name.keyword" or "a_status" or "c.state"
  string          field       = 1;

  FilterOp        op          = 2;

  // For EQ
  string          value       = 3;

  // For IN
  repeated string values      = 4;

  // If you need nested filtering (e.g. c is mapped as "nested"):
  // nested_path="c", field="c.state", op=EQ, value="active"
  string          nested_path = 5;
}

message Sort {
  // Example: "updated_at"
  string field = 1;
  bool   desc  = 2;
}

message SearchRequest {
  // Always filter by tenant for safety
  string          tenant_id = 1;

  // Optional full text query
  string          query     = 2;

  repeated Filter filters   = 3;

  // Pagination (simple from/size)
  int32           page      = 4; // 0-based
  int32           page_size = 5; // default 25, max 100

  repeated Sort   sort      = 6;
}

message SearchHit {
  string                 id     = 1;
  double                 score  = 2;

  // The indexed document (source)
  google.protobuf.Struct source = 3;
}

message SearchResponse {
  int64              total = 1;
  repeated SearchHit hits  = 2;
}
